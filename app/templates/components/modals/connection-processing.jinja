<!-- Connection Processing Modal -->
<div class="modal modal-blur fade" id="connection-processing-modal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-body text-center py-5">
                <div class="mb-3" id="connection-spinner">
                    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">Connecting...</span>
                    </div>
                </div>
                <div class="mb-3" id="connection-success" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon text-success">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                </div>
                <h4 id="connection-status-text">Establishing Connection...</h4>
                <p class="text-muted mb-0" id="connection-status-detail">Please wait while we connect to the issuer</p>
            </div>
        </div>
    </div>
</div>

<script>
let connectionCheckInterval = null;
let connectionTimeout = null;

function showConnectionProcessing() {
    const modal = new bootstrap.Modal(document.getElementById('connection-processing-modal'));
    modal.show();
    
    // Start checking connection state
    let attempts = 0;
    const maxAttempts = 10; // 10 attempts * 500ms = 5 seconds
    
    connectionCheckInterval = setInterval(async () => {
        attempts++;
        
        try {
            // Check if we have new connections or notifications
            const response = await fetch(window.location.href);
            const html = await response.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            // Check if there are new connections/notifications in the response
            const newConnectionsCount = doc.querySelectorAll('.card-sm .h2').length;
            const currentConnectionsCount = document.querySelectorAll('.card-sm .h2').length;
            
            if (newConnectionsCount > currentConnectionsCount || attempts >= maxAttempts) {
                // Connection established or timeout
                clearInterval(connectionCheckInterval);
                
                // Show success
                document.getElementById('connection-spinner').style.display = 'none';
                document.getElementById('connection-success').style.display = 'block';
                document.getElementById('connection-status-text').textContent = 'Connection Established!';
                document.getElementById('connection-status-detail').textContent = 'Redirecting...';
                
                // Redirect after a short delay
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            }
        } catch (error) {
            console.error('Error checking connection state:', error);
        }
        
        // Timeout after max attempts
        if (attempts >= maxAttempts) {
            clearInterval(connectionCheckInterval);
            document.getElementById('connection-status-text').textContent = 'Taking longer than expected...';
            document.getElementById('connection-status-detail').textContent = 'Refreshing page...';
            
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        }
    }, 500); // Check every 500ms
}

function cancelConnectionProcessing() {
    if (connectionCheckInterval) {
        clearInterval(connectionCheckInterval);
    }
    if (connectionTimeout) {
        clearTimeout(connectionTimeout);
    }
}

// Clean up on page unload
window.addEventListener('beforeunload', cancelConnectionProcessing);
</script>


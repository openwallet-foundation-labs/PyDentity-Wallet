{% for credential in session.get('credentials', []) %}
<div class="modal modal-blur fade" id="modal-credential-{{ loop.index }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon me-2">
                        <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                        <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                                    </svg>
                    Credential Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Credential Header -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row g-3 align-items-center">
                            <div class="col-auto">
                                <span class="avatar avatar-xl" style="background-image: url({{ credential.get('issuer', {}).get('image', '') if credential.get('issuer') is mapping else '' }})">
                                    {% set has_issuer_image = credential.get('issuer', {}).get('image') if credential.get('issuer') is mapping else '' %}
                                    {% if not has_issuer_image %}
                                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon">
                                        <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                                        <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                                    </svg>
                                    {% endif %}
                                </span>
                            </div>
                            <div class="col">
                                <h4 class="m-0">{{ credential.get('name', 'Verifiable Credential') }}</h4>
                                <div class="text-secondary mb-2">
                                    {% if credential.get('issuer') is mapping %}
                                    {{ credential.get('issuer', {}).get('name', 'Unknown Issuer') }}
                                    {% else %}Unknown Issuer{% endif %}
                                </div>
                                <div class="small text-muted">
                                    {% if credential.get('validFrom') %} 
                                    <strong>Issued:</strong> {{ credential['validFrom'].split('T')[0] }}
                                    {% elif credential.get('issuanceDate') %} 
                                    <strong>Issued:</strong> {{ credential['issuanceDate'].split('T')[0] }}
                                    {% endif %}
                                    {% if credential.get('validUntil') or credential.get('expirationDate') %}
                                    <br><strong>Expires:</strong> {{ credential['validUntil'].split('T')[0] if credential.get('validUntil') else credential['expirationDate'].split('T')[0] }}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Credential Attributes -->
                {% if credential.get('credentialSubject') or credential.get('attributes') %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h3 class="card-title">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon me-2">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                                <circle cx="9" cy="7" r="4"></circle>
                                <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                            </svg>
                            Credential Information
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="row g-2">
                            {% for key, value in (credential.get('credentialSubject', {}) or credential.get('attributes', {})).items() %}
                            <div class="col-12">
                                <div class="row g-2 align-items-center">
                                    <div class="col-4">
                                        <strong class="text-muted">{{ key|title }}</strong>
                                    </div>
                                    <div class="col-8">
                                        <span class="text-break">{{ value }}</span>
                                    </div>
                                </div>
                                {% if not loop.last %}<hr class="my-2">{% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Technical Details -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon me-2">
                                <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                                <line x1="8" y1="21" x2="16" y2="21"></line>
                                <line x1="12" y1="17" x2="12" y2="21"></line>
                            </svg>
                            Technical Details
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="accordion" id="accordion-technical-{{ loop.index }}">
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-technical-{{ loop.index }}" aria-expanded="false">
                                        Raw Credential Data
                                    </button>
                                </h2>
                                <div id="collapse-technical-{{ loop.index }}" class="accordion-collapse collapse" data-bs-parent="#accordion-technical-{{ loop.index }}">
                                    <div class="accordion-body">
                                        <pre class="bg-light p-3 rounded" style="max-height: 300px; overflow-y: auto;"><code>{{ credential|tojson(2) }}</code></pre>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick='downloadVc({{ credential | tojson }})'>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon me-1">
                        <path d="M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2 -2v-2"></path>
                        <path d="M7 11l5 5l5 -5"></path>
                        <path d="M12 4l0 12"></path>
                    </svg>
                    Download
                </button>
            </div>
        </div>
    </div>
</div>
{% endfor %}
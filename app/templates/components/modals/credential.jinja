{% for credential in session.get('credentials', []) %}
<div class="modal modal-blur fade" id="modal-credential-{{ loop.index }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon me-2">
                        <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                        <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                                    </svg>
                    Credential Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Credential Header -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row g-3 align-items-center">
                            <div class="col-auto">
                                {% set issuer = credential.get('issuer', {}) if credential.get('issuer') is mapping else {} %}
                                {% set issuer_image = issuer.get('image', '') %}
                                {% set issuer_name = issuer.get('name', 'Unknown') %}
                                {% set issuer_id = issuer.get('id', '') %}
                                
                                {% if issuer_image %}
                                <span class="avatar avatar-xl" style="background-image: url({{ issuer_image }})"></span>
                                {% else %}
                                <span class="avatar avatar-xl credential-identicon" 
                                      data-did="{{ issuer_id }}">
                                </span>
                                {% endif %}
                            </div>
                            <div class="col">
                                <h4 class="m-0">{{ credential.get('name', 'Verifiable Credential') }}</h4>
                                <div class="text-secondary mb-2">
                                    {% if credential.get('issuer') is mapping %}
                                    {{ credential.get('issuer', {}).get('name', 'Unknown Issuer') }}
                                    {% else %}Unknown Issuer{% endif %}
                                </div>
                                <div class="small text-muted">
                                    {% if credential.get('validFrom') %} 
                                    <strong>Issued:</strong> {{ credential['validFrom'].split('T')[0] }}
                                    {% elif credential.get('issuanceDate') %} 
                                    <strong>Issued:</strong> {{ credential['issuanceDate'].split('T')[0] }}
                                    {% endif %}
                                    {% if credential.get('validUntil') or credential.get('expirationDate') %}
                                    <br><strong>Expires:</strong> {{ credential['validUntil'].split('T')[0] if credential.get('validUntil') else credential['expirationDate'].split('T')[0] }}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Credential Attributes -->
                {% if credential.get('credentialSubject') or credential.get('attributes') %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h3 class="card-title">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon me-2">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                                <circle cx="9" cy="7" r="4"></circle>
                                <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                            </svg>
                            Credential Information
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="row g-2">
                            {% for key, value in (credential.get('credentialSubject', {}) or credential.get('attributes', {})).items() %}
                            <div class="col-12">
                                <div class="row g-2 align-items-center">
                                    <div class="col-4">
                                        <strong class="text-muted">{{ key|title }}</strong>
                                    </div>
                                    <div class="col-8">
                                        <span class="text-break">{{ value }}</span>
                                    </div>
                                </div>
                                {% if not loop.last %}<hr class="my-2">{% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Raw Credential -->
                <div class="card">
                    <div class="card-header" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#collapse-raw-{{ loop.index }}" aria-expanded="false">
                        <div class="d-flex align-items-center justify-content-between">
                            <h3 class="card-title mb-0">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon me-2">
                                    <polyline points="16 18 22 12 16 6"></polyline>
                                    <polyline points="8 6 2 12 8 18"></polyline>
                                </svg>
                                Raw Credential (JSON)
                            </h3>
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon chevron-icon">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </div>
                    </div>
                    <div id="collapse-raw-{{ loop.index }}" class="collapse">
                        <div class="card-body">
                            <pre class="bg-dark text-white p-3 rounded mb-3" style="max-height: 400px; overflow-y: auto; font-size: 0.875rem; line-height: 1.5;"><code class="text-white">{{ credential|tojson(2) }}</code></pre>
                            <button class="btn btn-sm btn-outline-primary" onclick="copyToClipboard({{ credential | tojson }}, event)">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon me-1">
                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                </svg>
                                Copy JSON
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick='downloadVc({{ credential | tojson }})'>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon me-1">
                        <path d="M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2 -2v-2"></path>
                        <path d="M7 11l5 5l5 -5"></path>
                        <path d="M12 4l0 12"></path>
                    </svg>
                    Download
                </button>
            </div>
        </div>
    </div>
</div>
{% endfor %}

<style>
.chevron-icon {
    transition: transform 0.3s ease;
}
[aria-expanded="true"] .chevron-icon {
    transform: rotate(180deg);
}
</style>

<script>
// Animate chevron on collapse toggle
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('[data-bs-toggle="collapse"]').forEach(function(element) {
        element.addEventListener('click', function() {
            const target = this.getAttribute('data-bs-target');
            const isExpanded = this.getAttribute('aria-expanded') === 'true';
            this.setAttribute('aria-expanded', !isExpanded);
        });
    });
});

function copyToClipboard(credential, event) {
    const jsonString = JSON.stringify(credential, null, 2);
    
    // Create temporary textarea
    const textarea = document.createElement('textarea');
    textarea.value = jsonString;
    textarea.style.position = 'fixed';
    textarea.style.opacity = '0';
    document.body.appendChild(textarea);
    
    // Select and copy
    textarea.select();
    document.execCommand('copy');
    document.body.removeChild(textarea);
    
    // Visual feedback
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    button.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon me-1">
            <polyline points="20 6 9 17 4 12"></polyline>
        </svg>
        Copied!
    `;
    button.classList.remove('btn-outline-primary');
    button.classList.add('btn-success');
    
    setTimeout(() => {
        button.innerHTML = originalText;
        button.classList.remove('btn-success');
        button.classList.add('btn-outline-primary');
    }, 2000);
}
</script>